<script>
        // Integration Logic: API URL
        const API_BASE_URL = "https://campaign-api-905468082258.asia-east1.run.app"; 

        let currentLang = 'tc';
        let currentErrorState = null; 

        const TRANSLATIONS = {
            tc: {
                date: "12/12 00:00 - 12/17 23:59 (GMT+8)",
                title: "雙 12 直播狂歡",
                subtitle: "直播耗鑽排行榜",
                desc_prefix: "應援人氣女神奪大獎，前十名瓜分總計",
                cta: "查看人氣女神活動",
                current_rank: "當前排名",
                total_spent: "總消費",
                lb_title: "總鑽排行榜",
                rewards_title: "排名獎勵",
                breakdown_gift: "直播禮物",
                breakdown_ticket: "限時表演",
                breakdown_menu: "挑逗表演",
                breakdown_lovense: "震動控制",
                rules_title: "活動說明",
                err_missing_title: '⚠️ 缺少用戶資訊', 
                err_missing_desc: '請登入 SWAG 後再使用本頁面。',
                err_conn_title: '連線錯誤', 
                err_conn_desc: '無法連接至伺服器，請稍後再試。', 
                err_data_title: '數據讀取失敗',
                rules_list: [
                    "直播間總鑽石僅計算：「直播禮物」、「限時表演票券」、「挑逗表演」、「震動控制」。",
                    "排行榜鑽石相同者，以先達成者排名在前。",
                    "排名鑽石獎勵將於活動結束後 3 個工作天內派發。",
                    "資料更新至少 5 分鐘，需登入帳號以正確顯示。",
                    "最終結果以官方計算為準。"
                ]
            },
            sc: {
                date: "12/12 00:00 - 12/17 23:59 (GMT+8)",
                title: "双 12 直播狂欢",
                subtitle: "直播耗钻排行榜",
                desc_prefix: "应援人气女神夺大奖，前十名瓜分总计",
                cta: "查看人气女神活动",
                current_rank: "当前排名",
                total_spent: "总消费",
                lb_title: "总钻排行榜",
                rewards_title: "排名奖励",
                breakdown_gift: "直播礼物",
                breakdown_ticket: "限时表演",
                breakdown_menu: "挑逗表演",
                breakdown_lovense: "震动控制",
                rules_title: "活动说明",
                err_missing_title: '⚠️ 缺少用户信息', 
                err_missing_desc: '请登入 SWAG 后再使用本页面。',
                err_conn_title: '连接错误', 
                err_conn_desc: '无法连接至服务器，请稍后再试。', 
                err_data_title: '数据读取失败',
                rules_list: [
                    "直播间总钻石仅计算：“直播礼物”，“限时表演票券”，“挑逗表演”，“震动控制”。",
                    "排行榜钻石相同者，以先达成者排名在前。",
                    "排名钻石奖励将于活动结束后 3 个工作天内派发。",
                    "资料更新至少 5 分钟，需登入帐号以正确显示。",
                    "最终结果以官方计算为准。"
                ]
            },
            en: {
                date: "Dec 12 - Dec 17 (GMT+8)",
                title: "Double 12 Carnival",
                subtitle: "Diamond Spending Leaderboard",
                desc_prefix: "Support Goddesses & Win Big! Share total",
                cta: "View Event",
                current_rank: "Rank",
                total_spent: "Total",
                lb_title: "Total Diamond Leaderboard",
                rewards_title: "Rewards",
                breakdown_gift: "Livestream Gift",
                breakdown_ticket: "Paid Show",
                breakdown_menu: "Tease Show",
                breakdown_lovense: "Vibe Control",
                rules_title: "Rules",
                err_missing_title: '⚠️ Missing User ID', 
                err_missing_desc: 'Please log in to SWAG before using this page.',
                err_conn_title: 'Connection Error', 
                err_conn_desc: 'Unable to connect to server. Please try again later.', 
                err_data_title: 'Data Error',
                rules_list: [
                    "Total diamonds calculated from: 'Livestream Gift', 'Paid Show', 'Tease Show', 'Vibe Control' only.",
                    "If diamonds are equal, the first to achieve the amount ranks higher.",
                    "Rewards distributed within 3 working days after event ends.",
                    "Data delayed 5+ mins. Log in for accurate view.",
                    "Official calculation results are final."
                ]
            },
            jp: {
                date: "12/12 - 12/17 (GMT+8)",
                title: "ダブル12 カーニバル",
                subtitle: "ダイヤ消費ランキング",
                desc_prefix: "女神を応援して大賞を狙おう！総額",
                cta: "イベントを見る",
                current_rank: "現在の順位",
                total_spent: "合計消費",
                lb_title: "ランキング",
                rewards_title: "ランキング報酬",
                breakdown_gift: "ギフト",
                breakdown_ticket: "有料ショー",
                breakdown_menu: "セクシーショー",
                breakdown_lovense: "リモートバイブ",
                rules_title: "注意事項",
                err_missing_title: '⚠️ ユーザー情報不足', 
                err_missing_desc: 'ご利用にはログインが必要です。',
                err_conn_title: '通信エラー', 
                err_conn_desc: 'サーバーに接続できません。後ほどお試しください。', 
                err_data_title: 'データエラー',
                rules_list: [
                    "対象：『ギフト』、『有料ショー』、『セクシーショー』、『リモートバイブ』のみ。",
                    "同ダイヤ数の場合は、先に達成した方が上位となります。",
                    "報酬はイベント終了後3営業日以内に配布されます。",
                    "データは5分以上遅延。正確な表示にはログインが必要です。",
                    "最終結果は公式の集計に準じます。"
                ]
            }
        };

        // Fallback Data
        const MOCK_LEADERBOARD = [
            { rank: 1, user_id: '...', total_diamond_cost: 0 },
            { rank: 2, user_id: '...', total_diamond_cost: 0 },
            { rank: 3, user_id: '...', total_diamond_cost: 0 },
            { rank: 4, user_id: '...', total_diamond_cost: 0 },
            { rank: 5, user_id: '...', total_diamond_cost: 0 },
            { rank: 6, user_id: '...', total_diamond_cost: 0 },
            { rank: 7, user_id: '...', total_diamond_cost: 0 },
            { rank: 8, user_id: '...', total_diamond_cost: 0 },
            { rank: 9, user_id: '...', total_diamond_cost: 0 },
            { rank: 10, user_id: '...', total_diamond_cost: 0 }
        ];

        const REWARDS = [100000, 90000, 80000, 70000, 60000, 50000, 40000, 30000, 20000, 10000];

        let currentLeaderboard = [...MOCK_LEADERBOARD];

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (
                    (lang === 'tc' && btn.innerText.includes('繁')) ||
                    (lang === 'sc' && btn.innerText.includes('简')) ||
                    (lang === 'en' && btn.innerText.includes('EN')) ||
                    (lang === 'jp' && btn.innerText.includes('日'))
                ) {
                    btn.classList.add('active');
                }
            });

            if (currentErrorState) {
                showError(currentErrorState.type, currentErrorState.debugInfo);
            }

            const t = TRANSLATIONS[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.innerHTML = t[key];
            });

            const rulesContainer = document.getElementById('rules-list');
            rulesContainer.innerHTML = '';
            t.rules_list.forEach(rule => {
                const li = document.createElement('li');
                li.textContent = rule;
                rulesContainer.appendChild(li);
            });
        }

        function showError(type, debugInfo = '') {
            currentErrorState = { type, debugInfo };
            const t = TRANSLATIONS[currentLang];
            let title = t.err_data_title;
            let desc = debugInfo;
            
            if (type === 'missing') {
                title = t.err_missing_title;
                desc = t.err_missing_desc;
            } else if (type === 'connection') {
                title = t.err_conn_title;
                desc = t.err_conn_desc;
            }

            const errorEl = document.getElementById('error-msg');
            errorEl.innerHTML = `<h3>${title}</h3><p>${desc}</p>${debugInfo && type !== 'missing' ? `<div class="error-debug">${debugInfo}</div>` : ''}`;
            errorEl.classList.remove('hidden');
            document.getElementById('dashboard-container').classList.add('hidden');
        }

        function renderTables() {
            const lbBody = document.getElementById('leaderboard-body');
            lbBody.innerHTML = '';
            
            currentLeaderboard.forEach(item => {
                let rankClass = '';
                if(item.rank === 1) rankClass = 'rank-1';
                else if(item.rank === 2) rankClass = 'rank-2';
                else if(item.rank === 3) rankClass = 'rank-3';

                const div = document.createElement('div');
                div.className = 'align-row';
                const scoreText = item.total_diamond_cost > 0 ? item.total_diamond_cost.toLocaleString() : '-';
                
                div.innerHTML = `
                    <span class="lb-rank ${rankClass}">${item.rank}</span>
                    <span class="lb-score">${scoreText}</span>
                `;
                lbBody.appendChild(div);
            });

            const rewardsBody = document.getElementById('rewards-body');
            rewardsBody.innerHTML = '';
            REWARDS.forEach((val) => {
                const div = document.createElement('div');
                div.className = 'align-row';
                div.innerHTML = `<div class="r-val">${val.toLocaleString()}</div>`;
                rewardsBody.appendChild(div);
            });
        }

        // --- FIXED: User ID Parsing Logic (Copied exactly from index_001) ---
        function getUserId() {
            let userId = null;
            const currentUrl = window.location.href;
            const regex = /(?:[?&#/]|^)user_id=([^&#]*)/i;
            
            // 1. Try direct match
            const match = currentUrl.match(regex);
            if (match && match[1]) userId = match[1];
            
            // 2. Try decoded match (Critical for iframes)
            if (!userId) {
                try {
                    const decoded = decodeURIComponent(currentUrl);
                    const m2 = decoded.match(regex);
                    if (m2 && m2[1]) userId = m2[1];
                } catch(e){}
            }
            return userId;
        }

        async function fetchUserData() {
            const userId = getUserId();
            const errorEl = document.getElementById('error-msg');
            const loader = document.getElementById('loading-dash');
            const dashContainer = document.getElementById('dashboard-container');
            
            errorEl.classList.add('hidden');
            dashContainer.classList.remove('hidden');

            if (!userId) {
                showError('missing');
                renderTables();
                return;
            }

            loader.classList.remove('hidden');

            const resetDashboard = () => {
                document.getElementById('disp-rank').textContent = '--';
                document.getElementById('disp-total').textContent = '0';
                ['gift', 'ticket', 'command', 'lovense'].forEach(id => {
                    document.getElementById(`disp-${id}`).textContent = '0';
                });
            };

            try {
                // --- FIXED: Removed the trailing slash before '?' ---
                // index_001: API_URL + '?user_id='
                // Was: API_BASE_URL + '/?user_id=' (This causes 301 Redirects -> CORS Fail)
                const fetchUrl = `${API_BASE_URL}?user_id=${encodeURIComponent(userId)}`;

                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    redirect: 'follow',
                    mode: 'cors',
                    credentials: 'omit'
                });

                if (response.status === 404) {
                    resetDashboard();
                    renderTables(); 
                    return;
                }

                if (!response.ok) throw new Error(`API Status: ${response.status}`);

                const data = await response.json();

                if (data.user_stats) {
                    document.getElementById('disp-rank').textContent = data.user_stats.rank;
                    document.getElementById('disp-total').textContent = (data.user_stats.total_diamond_cost || 0).toLocaleString();
                    
                    if (data.user_stats.breakdown) {
                        const bd = data.user_stats.breakdown;
                        document.getElementById('disp-gift').textContent = (bd.livestream_gift_diamonds || 0).toLocaleString();
                        document.getElementById('disp-ticket').textContent = (bd.show_ticket_diamonds || 0).toLocaleString();
                        document.getElementById('disp-command').textContent = (bd.command_diamonds || 0).toLocaleString();
                        document.getElementById('disp-lovense').textContent = (bd.lovense_diamonds || 0).toLocaleString();
                    }
                } else {
                    resetDashboard();
                }

                if (data.leaderboard_top_10 && Array.isArray(data.leaderboard_top_10) && data.leaderboard_top_10.length > 0) {
                    currentLeaderboard = data.leaderboard_top_10;
                    renderTables();
                }

            } catch (err) {
                console.error("Fetch error:", err);
                showError('connection', err.toString());
                resetDashboard();
                renderTables(); 
            } finally {
                loader.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setLang('tc');
            renderTables();
            fetchUserData();
        });
    </script>
